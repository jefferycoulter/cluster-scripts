#!/usr/bin/env bash

set -euo pipefail

INPUT_DIRS=()
FILES_TO_GET=()
OUTPUT_DIR=""

WD=$(pwd)

# argument parsing
while [[ $# -gt 0 ]]; do
  	case "$1" in
    	--input_dirs)
			shift
			while [[ $# -gt 0 && $1 != --* ]]; do
				INPUT_DIRS+=("$WD/$1")
				shift
			done
			;;
    	--files_to_get)
			shift
			while [[ $# -gt 0 && $1 != --* ]]; do
				FILES_TO_GET+=("$1")
				shift
			done
			;;
    	--output_dir)
			OUTPUT_DIR="$2"
			shift 2
			;;
    	*)
      		echo "Unknown argument: $1" >&2
      		exit 1
      		;;
	esac
done

if [[ ${#INPUT_DIRS[@]} -eq 0 || ${#FILES_TO_GET[@]} -eq 0 || -z "$OUTPUT_DIR" ]]; then
  	echo "Usage: $0 --input_dirs dir1 [dir2 ...] --files_to_get file1 [file2 ...] --output_dir output" >&2
  	exit 1
fi
mkdir -p "$OUTPUT_DIR"

# main loop
# we want to find */data directories
for root in "${INPUT_DIRS[@]}"; do
	if [[ ! -d "$root" ]]; then
    	echo "Warning: input dir '$root' does not exist or is not a directory." >&2
    	continue
  	fi

	# under the current root, recursively check subdirectories for 'data'. for each occurence of 'data',
	# add its parent directory to the list of found entries
  	while IFS= read -r abs_dir; do
		sim_dir="$(dirname "$data_dir")"     # directory that contains 'data
    	rel="${sim_dir#"$root"/}"            # relative path under the root

		# if data_dir is directly under root, rel becomes empty; keep it as "."
		if [[ "$sim_dir" == "$root" ]]; then
			rel="."
		fi

    	# mirror relative tree under OUTPUT_DIR
		output_sim_dir="$OUTPUT_DIR/$rel"
		mkdir -p "$output_sim_dir"

		for file_to_get in "${FILES_TO_GET[@]}"; do
			input_file_path="$data_dir/$file_to_get"
			output_file_path="$output_sim_dir/$file_to_get"

			if [[ -f "$input_file_path" ]]; then
				cp "$input_file_path" "$output_file_path"
				echo "Copied '$input_file_path' to '$output_file_path'."
			else
				echo "Warning: '$input_file_path' does not exist."
			fi
		done
  	done < <(find "$root" -type d -name 'data' -print | sort -u)
done

echo "Finished copying files to '$OUTPUT_DIR' (relative structure preserved)."
